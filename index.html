<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Éditeur Monaco – Multilangage + Upload</title>
  <style>
    html,body{height:100%;margin:0}
    .topbar{
      height:48px;display:flex;align-items:center;gap:8px;
      padding:6px 12px;background:#1e1e1e;color:#fff
    }
    .btn{background:#0e639c;border:none;padding:6px 10px;border-radius:6px;color:#fff;cursor:pointer}
    .select,.input{padding:6px;border-radius:6px}
    #editor{height:60%}
    #preview{height:40%;border-top:2px solid #333;width:100%;background:#111;color:#fff;overflow:auto;position:relative}
    iframe{width:100%;height:100%;border:none}
    #preview.fullscreen {
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      z-index:9999;
      border:none;
      background:#000;
    }
    #exitFull {
      position:absolute;
      top:10px; right:10px;
      background:#c00; color:#fff;
      border:none;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:bold;
      display:none;
      z-index:10000;
    }
    #preview.fullscreen #exitFull { display:block; }
  </style>
</head>
<body>
  <div class="topbar">
    <strong>Éditeur Monaco + Visualisation</strong>
    <select id="lang" class="select">
      <option value="html">HTML</option>
      <option value="css">CSS</option>
      <option value="javascript">JavaScript</option>
      <option value="python">Python</option>
      <option value="markdown">Markdown</option>
      <option value="lua">Lua</option>
      <option value="luau">Luau</option>
      <option value="cpp">C++</option>
    </select>
    <input id="filename" class="input" value="code" placeholder="nom du fichier" />
    <input type="file" id="fileInput" class="input" />
    <button id="themeToggle" class="btn">Thème sombre</button>
    <button id="visualiser" class="btn">Visualiser</button>
    <button id="fullscreen" class="btn">Plein écran</button>
    <button id="download" class="btn">Télécharger</button>
  </div>

  <div id="editor"></div>
  <div id="preview">
    <button id="exitFull">Quitter plein écran ✕</button>
  </div>

  <!-- Librairies -->
  <script src="https://unpkg.com/monaco-editor@0.39.0/min/vs/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/fengari@0.1.4/dist/fengari.js"></script>
  <script src="https://unpkg.com/fengari-web@0.1.4/dist/fengari-web.js"></script>
  <script src="https://unpkg.com/luau-wasm/dist/luau.min.js"></script>

  <script>
    let pyodideReady = false;
    let pyodide = null;

    async function initPyodide() {
      pyodide = await loadPyodide();
      pyodideReady = true;
      console.log("✅ Pyodide prêt !");
    }
    initPyodide();

    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.39.0/min/vs' } });

    require(['vs/editor/editor.main'], function () {
      const initialCode = `<!-- Exemple HTML -->
<h1>Bonjour Monde !</h1>
<p>Modifie le code et clique sur Visualiser.</p>`;

      const editor = monaco.editor.create(document.getElementById('editor'), {
        value: initialCode,
        language: 'html',
        theme: 'vs-dark',
        automaticLayout: true,
        minimap: { enabled: true },
        fontSize: 14,
      });

      const langSelect = document.getElementById('lang');
      const filenameInput = document.getElementById('filename');
      const previewDiv = document.getElementById('preview');
      const exitFullBtn = document.getElementById('exitFull');
      const fileInput = document.getElementById('fileInput');

      // Mapping extension -> Monaco language
      const extToLang = {
        html: 'html',
        htm: 'html',
        css: 'css',
        js: 'javascript',
        py: 'python',
        lua: 'lua',
        luau: 'luau',
        md: 'markdown',
        cpp: 'cpp',
        c: 'cpp'
      };

      // Upload / import fichier
      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
          editor.setValue(ev.target.result);
          const nameParts = file.name.split('.');
          const ext = nameParts[nameParts.length - 1].toLowerCase();
          const lang = extToLang[ext] || 'plaintext';
          langSelect.value = lang;
          monaco.editor.setModelLanguage(editor.getModel(), lang);
          filenameInput.value = nameParts.slice(0, -1).join('.') || 'code';
        };
        reader.readAsText(file);
      });

      // Changer le langage manuellement
      langSelect.addEventListener('change', e => {
        monaco.editor.setModelLanguage(editor.getModel(), e.target.value);
      });

      // Thème clair/sombre
      let dark = true;
      document.getElementById('themeToggle').addEventListener('click', ()=>{
        dark = !dark;
        monaco.editor.setTheme(dark ? 'vs-dark' : 'vs');
      });

      const getExtension = lang => ({
        html:'html', css:'css', javascript:'js', python:'py', markdown:'md', lua:'lua', luau:'luau', cpp:'cpp'
      }[lang] || 'txt');

      // Télécharger le fichier
      const downloadFile = ()=>{
        const lang = langSelect.value;
        const ext = getExtension(lang);
        const name = filenameInput.value.trim() || 'code';
        const fileName = name.endsWith('.'+ext) ? name : `${name}.${ext}`;
        const blob = new Blob([editor.getValue()], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(a.href);
      };
      document.getElementById('download').addEventListener('click', downloadFile);
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S, downloadFile);

      // --- VISUALISATION ---
      document.getElementById('visualiser').addEventListener('click', async ()=>{
        const code = editor.getValue();
        const lang = langSelect.value;
        previewDiv.innerHTML = '<button id="exitFull">Quitter plein écran ✕</button>';

        // HTML/CSS/JS
        if (lang === 'html' || lang === 'javascript' || lang === 'css') {
          const iframe = document.createElement('iframe');
          if (lang === 'html') iframe.srcdoc = code;
          else if (lang === 'css') iframe.srcdoc = `<style>${code}</style>`;
          else iframe.srcdoc = `<script>${code}<\/script>`;
          previewDiv.appendChild(iframe);

        // Python
        } else if (lang === 'python') {
          if (!pyodideReady) {
            previewDiv.innerHTML += '<p>Chargement de l’interpréteur Python...</p>';
            return;
          }
          try {
            const output = await pyodide.runPythonAsync(code);
            previewDiv.innerHTML += `<pre style="padding:8px;">${output ?? '(aucune sortie)'}</pre>`;
          } catch(err) {
            previewDiv.innerHTML += `<pre style="color:red;padding:8px;">Erreur : ${err}</pre>`;
          }

        // Markdown
        } else if (lang === 'markdown') {
          const html = marked.parse(code);
          previewDiv.innerHTML += `<div style="padding:12px;background:#fff;color:#000;">${html}</div>`;

        // Lua
        } else if (lang === 'lua') {
          try {
            const luaEnv = fengari.load(code);
            luaEnv();
            previewDiv.innerHTML += `<pre style="padding:8px;">(Script Lua exécuté)</pre>`;
          } catch(err) {
            previewDiv.innerHTML += `<pre style="color:red;padding:8px;">Erreur Lua : ${err}</pre>`;
          }

        // Luau
        } else if (lang === 'luau') {
          try {
            const L = new LuauVM();
            L.execute(code);
            previewDiv.innerHTML += `<pre style="padding:8px;">(Script Luau exécuté)</pre>`;
          } catch(err) {
            previewDiv.innerHTML += `<pre style="color:red;padding:8px;">Erreur Luau : ${err}</pre>`;
          }

        // Autres langages
        } else {
          previewDiv.innerHTML += `<p style="padding:8px;">Visualisation non disponible pour <b>${lang}</b>.</p>`;
        }

        document.getElementById('exitFull').addEventListener('click', ()=>previewDiv.classList.remove('fullscreen'));
      });

      // --- PLEIN ÉCRAN ---
      document.getElementById('fullscreen').addEventListener('click', ()=>{
        previewDiv.classList.toggle('fullscreen');
      });
      exitFullBtn.addEventListener('click', ()=>previewDiv.classList.remove('fullscreen'));
    });
  </script>
</body>
</html>
